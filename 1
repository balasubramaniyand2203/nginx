FROM apache/airflow:2.1.0-python3.7

USER root

# Fix Debian buster repo (since it's EOL)
RUN sed -i 's/deb.debian.org/archive.debian.org/g' /etc/apt/sources.list && \
    sed -i 's|security.debian.org|archive.debian.org/|g' /etc/apt/sources.list && \
    sed -i '/buster-updates/d' /etc/apt/sources.list

# Install tools
RUN apt-get update && \
    apt-get install -y wget tar gzip && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Install OpenJDK 17.0.16 (Temurin build)
RUN wget https://github.com/adoptium/temurin17-binaries/releases/download/jdk-17.0.16%2B8/OpenJDK17U-jdk_x64_linux_hotspot_17.0.16_8.tar.gz -O /tmp/openjdk17.tar.gz && \
    mkdir -p /usr/lib/jvm && \
    tar -xvzf /tmp/openjdk17.tar.gz -C /usr/lib/jvm && \
    rm /tmp/openjdk17.tar.gz

# Set Java environment
ENV JAVA_HOME=/usr/lib/jvm/jdk-17.0.16+8
ENV PATH="${JAVA_HOME}/bin:${PATH}"

USER airflow
WORKDIR /var/opt

ADD ./dags /opt/airflow/dags
ADD ./plugins /opt/airflow/plugins
ADD ./requirements.txt /var/opt/

RUN python3 -m pip install --upgrade pip && \
    pip install -r requirements.txt && \
    pip install psycopg2-binary
